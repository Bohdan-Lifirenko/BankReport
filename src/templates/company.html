{% extends "base.html" %}

{% block title %}{{ company.name }} - Company Information{% endblock %}

{% block content %}
<div class="company-details">
    <div class="text-center mb-4">
        <a href="/" class="btn btn-secondary">‚Üê Back to Search</a>
    </div>

    <div class="text-white text-center p-4 rounded-3 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h2 class="fw-bold mb-2">{{ company.name }}</h2>
        <p class="fs-5 mb-0 opacity-75">Tax ID (EDRPOU): {{ tax_id }}</p>
    </div>

    <h3 class="text-dark mb-3">üìä Company Information</h3>

    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üè∑Ô∏è Tax ID (–Ñ–î–†–ü–û–£)</div>
                    <div class="fs-5 text-dark">{{ company.tax_id }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üè¢ Company Name</div>
                    <div class="fs-5 text-dark">{{ company.name }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìà KVED Code</div>
                    <div class="fs-5 text-dark">{{ company.kved }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìã OPF Code</div>
                    <div class="fs-5 text-dark">{{ company.opf_code }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìç KATOTTG Code</div>
                    <div class="fs-5 text-dark">{{ company.katottg }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üó∫Ô∏è Region Code</div>
                    <div class="fs-5 text-dark">{{ company.region_code }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üèòÔ∏è Local Code</div>
                    <div class="fs-5 text-dark">{{ company.local_code }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Balance Waterfall Chart Section -->
    <div class="card mb-4">
        <div class="card-header bg-white">
            <h4 class="mb-0">üìà Balance Sheet Waterfall Chart</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="dateSelect" class="form-label fw-bold">Select Reporting Date:</label>
                    <select id="dateSelect" class="form-select">
                        <option value="">-- Select a date --</option>
                        {% for date in available_dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="balanceChart" style="width: 100%; height: 400px;">
                <div class="text-center text-muted py-5">
                    <p>Select a date to view the balance waterfall chart</p>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-success border-start border-success border-4">
        <h5 class="text-success mb-2">‚ÑπÔ∏è Field Descriptions</h5>
        <ul class="text-muted mb-0" style="line-height: 1.8;">
            <li><strong>KVED:</strong> Main economic activity code (–ö–í–ï–î) - used for industry classification</li>
            <li><strong>OPF Code:</strong> Legal form code (–û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω–æ-–ø—Ä–∞–≤–æ–≤–∞ —Ñ–æ—Ä–º–∞)</li>
            <li><strong>KATOTTG:</strong> Administrative-territorial unit code where the company is registered</li>
            <li><strong>Region Code:</strong> Oblast (region) code</li>
            <li><strong>Local Code:</strong> Local administrative level code (community/district)</li>
        </ul>
    </div>

    <div class="text-center mt-4">
        <a href="/api/company/{{ tax_id }}" class="btn btn-primary" target="_blank">üìÑ View JSON Data</a>
    </div>
</div>

<!-- Plotly JS -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    const taxId = "{{ tax_id }}";
    const dateSelect = document.getElementById('dateSelect');
    const chartDiv = document.getElementById('balanceChart');

    dateSelect.addEventListener('change', function() {
        const selectedDate = this.value;
        if (!selectedDate) {
            chartDiv.innerHTML = '<div class="text-center text-muted py-5"><p>Select a date to view the balance waterfall chart</p></div>';
            return;
        }

        // Fetch balance data from API
        fetch(`/api/balance/${taxId}?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    chartDiv.innerHTML = `<div class="alert alert-warning">${data.message || data.error}</div>`;
                    return;
                }

                // Create waterfall chart
                const trace = {
                    type: 'waterfall',
                    orientation: 'v',
                    x: ['Equity', 'Liabilities', 'Total Assets'],
                    y: [data.equity, data.liabilities, 0],
                    measure: ['absolute', 'relative', 'total'],
                    text: [
                        data.equity ? data.equity.toLocaleString() : 'N/A',
                        data.liabilities ? data.liabilities.toLocaleString() : 'N/A',
                        data.assets ? data.assets.toLocaleString() : 'N/A'
                    ],
                    textposition: 'outside',
                    connector: {
                        line: { color: 'rgb(63, 63, 63)' }
                    },
                    increasing: { marker: { color: '#28a745' } },
                    decreasing: { marker: { color: '#dc3545' } },
                    totals: { marker: { color: '#667eea' } }
                };

                const layout = {
                    title: {
                        text: `Balance Sheet Breakdown (${selectedDate})`,
                        font: { size: 18 }
                    },
                    xaxis: { title: 'Components' },
                    yaxis: { title: 'Value (thousands UAH)' },
                    showlegend: false,
                    margin: { t: 60, b: 60, l: 80, r: 40 }
                };

                const config = { responsive: true };

                Plotly.newPlot(chartDiv, [trace], layout, config);
            })
            .catch(error => {
                chartDiv.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
            });
    });
</script>
{% endblock %}
