{% extends "base.html" %}

{% block title %}{{ company.name }} - –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–º–ø–∞–Ω—ñ—é{% endblock %}

{% block content %}
<div class="company-details">
    <div class="text-center mb-4">
        <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –¥–æ –ø–æ—à—É–∫—É</a>
    </div>
    <h3 class="text-dark mb-3">üìä –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–º–ø–∞–Ω—ñ—é</h3>

    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üè∑Ô∏è –ü–æ–¥–∞—Ç–∫–æ–≤–∏–π –∫–æ–¥ –∫–æ–º–ø–∞–Ω—ñ—ó (–Ñ–î–†–ü–û–£)</div>
                    <div class="fs-5 text-dark">{{ company.tax_id }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üè¢ –ü–æ–≤–Ω–∞ –æ—Ñ—ñ—Ü—ñ–π–Ω–∞ –Ω–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó</div>
                    <div class="fs-5 text-dark">{{ company.name }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìà –û—Å–Ω–æ–≤–Ω–∏–π –≤–∏–¥ –µ–∫–æ–Ω–æ–º—ñ—á–Ω–æ—ó –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ –∫–æ–º–ø–∞–Ω—ñ—ó (–ö–í–ï–î)</div>
                    <div class="fs-5 text-dark">{{ company.kved }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìã –ö–æ–¥ –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π–Ω–æ-–ø—Ä–∞–≤–æ–≤–æ—ó —Ñ–æ—Ä–º–∏ –∫–æ–º–ø–∞–Ω—ñ—ó</div>
                    <div class="fs-5 text-dark">{{ company.opf_code }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üìç –ö–æ–¥ –ö–ê–¢–û–¢–¢–ì</div>
                    <div class="fs-5 text-dark">{{ company.katottg }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üó∫Ô∏è –ö–æ–¥ —Ä–µ–≥—ñ–æ–Ω—É (–æ–±–ª–∞—Å—Ç—ñ)</div>
                    <div class="fs-5 text-dark">{{ company.region_code }}</div>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card bg-light border-0 h-100 info-card">
                <div class="card-body">
                    <div class="info-label mb-1">üèòÔ∏è –ö–æ–¥ –º—ñ—Å—Ü–µ–≤–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è</div>
                    <div class="fs-5 text-dark">{{ company.local_code }}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Chart Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">üìà –ì—Ä–∞—Ñ—ñ–∫ –¥–∏–Ω–∞–º—ñ–∫–∏ –≤–∏—Ä—É—á–∫–∏</h4>
        </div>
        <div class="card-body">
            <div id="revenue-chart" style="width: 100%; height: 400px;"></div>
        </div>
    </div>

    <!-- Balance Waterfall Chart Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">üìà –ì—Ä–∞—Ñ—ñ–∫ –±–∞–ª–∞–Ω—Å—É (Waterfall)</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="dateSelect" class="form-label fw-bold">–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –∑–≤—ñ—Ç–Ω–æ—Å—Ç—ñ:</label>
                    <select id="dateSelect" class="form-select">
                        <option value="">-- –í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É --</option>
                        {% for date in available_dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="balanceChart" style="width: 100%; height: 400px;">
                <div class="text-center text-muted py-5">
                    <p>–í–∏–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É, —â–æ–± –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plotly JS -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
    const taxId = "{{ tax_id }}";
    const dateSelect = document.getElementById('dateSelect');
    const chartDiv = document.getElementById('balanceChart');

    // Parse revenue data from server
    const revenueData = {{ revenue_data | safe }};

    if (revenueData && revenueData.length > 0) {
        // Extract dates and values
        const dates = revenueData.map(item => item.my_date);
        const values = revenueData.map(item => item.value);

        // Create the Plotly chart
        const trace = {
            x: dates,
            y: values,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Revenue',
            line: {
                color: '#667eea',
                width: 3
            },
            marker: {
                color: '#764ba2',
                size: 8
            },
            fill: 'tozeroy',
            fillcolor: 'rgba(102, 126, 234, 0.2)'
        };

        const layout = {
            title: {
                text: '–í–∏—Ä—É—á–∫–∞ –∑–∞ –≤—Å—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ –¥–∞—Ç–∏',
                font: { size: 18, color: '#333' }
            },
            xaxis: {
                title: '–î–∞—Ç–∞',
                showgrid: true,
                gridcolor: '#e0e0e0'
            },
            yaxis: {
                title: '–í–∏—Ä—É—á–∫–∞ (–≥—Ä–Ω)',
                showgrid: true,
                gridcolor: '#e0e0e0',
                tickformat: ',.0f'
            },
            hovermode: 'x unified',
            plot_bgcolor: '#fafafa',
            paper_bgcolor: 'white',
            margin: { t: 50, r: 30, b: 50, l: 80 }
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d']
        };

        Plotly.newPlot('revenue-chart', [trace], layout, config);
    } else {
        // Show message if no data available
        document.getElementById('revenue-chart').innerHTML =
            '<div class="alert alert-info text-center m-4">' +
            '<i class="fs-1">üìä</i><br>' +
            '<strong>–î–∞–Ω—ñ –ø—Ä–æ –≤–∏—Ä—É—á–∫—É —Ü—ñ—î—ó –∫–æ–º–ø–∞–Ω—ñ—ó –≤—ñ–¥—Å—É—Ç–Ω—ñ.</strong>' +
            '</div>';
    }

    dateSelect.addEventListener('change', function() {
        const selectedDate = this.value;
        if (!selectedDate) {
            chartDiv.innerHTML = '<div class="text-center text-muted py-5"><p>Select a date to view the balance waterfall chart</p></div>';
            return;
        }

        // Fetch balance data from API
        fetch(`/api/balance/${taxId}?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    chartDiv.innerHTML = `<div class="alert alert-warning">${data.message || data.error}</div>`;
                    return;
                }

                // Create waterfall chart
                const trace = {
                    type: 'waterfall',
                    orientation: 'v',
                    x: ['Equity', 'Liabilities', 'Total Assets'],
                    y: [data.equity, data.liabilities, 0],
                    measure: ['absolute', 'relative', 'total'],
                    text: [
                        data.equity ? data.equity.toLocaleString() : 'N/A',
                        data.liabilities ? data.liabilities.toLocaleString() : 'N/A',
                        data.assets ? data.assets.toLocaleString() : 'N/A'
                    ],
                    textposition: 'outside',
                    connector: {
                        line: { color: 'rgb(63, 63, 63)' }
                    },
                    increasing: { marker: { color: '#28a745' } },
                    decreasing: { marker: { color: '#dc3545' } },
                    totals: { marker: { color: '#667eea' } }
                };

                const layout = {
                    title: {
                        text: `–ë–∞–ª–∞–Ω—Å –∑–∞ (${selectedDate})`,
                        font: { size: 18 }
                    },
                    xaxis: { title: '–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏' },
                    yaxis: { title: '–í–∞—Ä—Ç—ñ—Å—Ç—å (—É —Ç–∏—Å—è—á–∞—Ö –≥—Ä–Ω)' },
                    showlegend: false,
                    margin: { t: 60, b: 60, l: 80, r: 40 }
                };

                const config = { responsive: true };

                Plotly.newPlot(chartDiv, [trace], layout, config);
            })
            .catch(error => {
                chartDiv.innerHTML = `<div class="alert alert-danger">Error loading data: ${error.message}</div>`;
            });
    });
</script>
{% endblock %}
